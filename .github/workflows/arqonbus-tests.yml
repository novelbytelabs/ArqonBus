name: ArqonBus Test Profiles

on:
  pull_request:
    branches: [main, dev]
  push:
    branches: [main, dev, feature/**]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unit:
    name: Unit Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run unit tests
        run: |
          COVERAGE_FILE=.coverage.unit python -m pytest -q \
            -m "unit and not regression and not e2e and not external and not performance" \
            --cov=arqonbus --cov-branch --cov-report=term-missing --cov-report=xml:coverage-unit.xml \
            tests
      - name: Upload unit coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: |
            .coverage.unit
            coverage-unit.xml

  integration:
    name: Integration Suite
    runs-on: ubuntu-latest
    needs: unit
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run integration tests
        run: |
          COVERAGE_FILE=.coverage.integration python -m pytest -q \
            -m "integration and not e2e and not external and not performance" \
            --cov=arqonbus --cov-branch --cov-report=term-missing --cov-report=xml:coverage-integration.xml \
            tests/integration
      - name: Upload integration coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: |
            .coverage.integration
            coverage-integration.xml

  e2e:
    name: End-to-End Suite
    runs-on: ubuntu-latest
    needs: unit
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run e2e tests
        run: |
          COVERAGE_FILE=.coverage.e2e python -m pytest -q \
            -m "e2e and not external and not performance" \
            --cov=arqonbus --cov-branch --cov-report=term-missing --cov-report=xml:coverage-e2e.xml \
            tests
      - name: Upload e2e coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-e2e
          path: |
            .coverage.e2e
            coverage-e2e.xml

  regression:
    name: Regression Suite
    runs-on: ubuntu-latest
    needs: unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      - name: Run regression tests
        run: |
          COVERAGE_FILE=.coverage.regression python -m pytest -q \
            -m "regression and not external and not performance" \
            --cov=arqonbus --cov-branch --cov-report=term-missing --cov-report=xml:coverage-regression.xml \
            tests
      - name: Upload regression coverage data
        uses: actions/upload-artifact@v4
        with:
          name: coverage-regression
          path: |
            .coverage.regression
            coverage-regression.xml

  coverage:
    name: Coverage Gate + Codecov
    runs-on: ubuntu-latest
    needs: [unit, integration, e2e, regression]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install coverage tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage[toml]
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-data
      - name: Combine coverage
        run: |
          files=$(find coverage-data -name ".coverage.*" -print)
          if [ -z "$files" ]; then
            echo "No coverage files found"
            exit 1
          fi
          python -m coverage combine $files
          python -m coverage report --fail-under=35
          python -m coverage xml -o coverage.xml
      - name: Upload combined coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-combined
          path: coverage.xml
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: coverage.xml
          fail_ci_if_error: true
          flags: unit,integration,e2e,regression
          verbose: true
